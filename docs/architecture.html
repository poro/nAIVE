<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>nAIVE Engine Architecture</title>
  <style>
    body { background: #1a1a2e; color: #e0e0e0; font-family: system-ui; margin: 0; padding: 20px; }
    h1 { color: #e94560; text-align: center; }
    h2 { color: #0f3460; background: #e94560; padding: 8px 16px; border-radius: 4px; display: inline-block; }
    .diagram { background: #16213e; border-radius: 8px; padding: 20px; margin: 20px 0; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>nAIVE - AI-Native Interactive Visual Engine</h1>

  <h2>System Architecture</h2>
  <div class="diagram">
    <pre class="mermaid">
graph TB
    subgraph CLI["CLI Layer"]
        CLAP["clap CLI Parser<br/>--scene --pipeline --project"]
        MAIN["main.rs<br/>Entry Point"]
    end

    subgraph ENGINE["Engine Core (engine.rs)"]
        EL["winit Event Loop<br/>ApplicationHandler"]
        DT["Delta Time"]
        PAUSE["Pause State"]
    end

    subgraph ECS["ECS World (hecs)"]
        SW["SceneWorld<br/>world + entity_registry"]
        TRANSFORM["Transform"]
        MESH_R["MeshRenderer"]
        PL["PointLight"]
        PLAYER["Player"]
        CAM["Camera"]
        SCRIPT_C["Script"]
        TAGS["Tags / EntityId"]
        CC["CharacterController"]
        GS["GaussianSplat"]
        HIDDEN["Hidden<br/>visibility marker"]
        MAT_OVR["MaterialOverride<br/>runtime emission/roughness"]
    end

    subgraph SCENE["Scene System"]
        YAML_P["YAML Parser<br/>serde_yaml"]
        SCENE_F["SceneFile<br/>entities + settings"]
        SPAWN["spawn_all_entities()"]
        RECONCILE["reconcile_scene()<br/>hot-reload diff"]
    end

    subgraph RENDER["Rendering Pipeline"]
        GPU["GpuState<br/>wgpu device/queue/surface"]
        PIPE_YAML["Pipeline YAML<br/>DAG of passes"]
        COMPILED["CompiledPipeline<br/>resources + passes"]
        SHADOW["Shadow Pass<br/>directional shadow map"]
        GBUF["G-Buffer Pass<br/>albedo + normal + depth"]
        LIGHT["Lighting Pass<br/>Cook-Torrance GGX + shadows"]
        BLOOM_P["Bloom Pass<br/>HDR glow extraction"]
        TONE["Tonemap Pass<br/>HDR → SDR"]
        FXAA_P["FXAA Pass<br/>anti-aliasing"]
        SPLAT_P["Splat Pass<br/>Gaussian billboards"]
        FWD["Forward Fallback"]
    end

    subgraph UI["UI Overlay (Phase 16)"]
        FONT["BitmapFont<br/>6×8 pixel atlas, 95 glyphs"]
        UI_R["UiRenderer<br/>immediate-mode 2D"]
        UI_TEXT["ui.text()<br/>screen-space text"]
        UI_RECT["ui.rect()<br/>colored rectangles"]
        UI_FLASH["ui.flash()<br/>screen effects"]
        ENT_CMD["EntityCommandQueue<br/>deferred spawn/destroy"]
    end

    subgraph SHADER["Shader System"]
        SLANG["SLANG Compiler<br/>shader-slang crate"]
        WGSL["WGSL Fallback"]
        REFLECT["Reflection API<br/>auto bind group layouts"]
    end

    subgraph PHYSICS["Physics (Rapier 3D)"]
        PW["PhysicsWorld<br/>rigid bodies + colliders"]
        CHAR["Character Controller<br/>move_character()"]
        STEP["step() + sync_to_ecs()"]
    end

    subgraph SCRIPTING["Lua Scripting (mlua)"]
        LUA["ScriptRuntime<br/>single Lua VM"]
        ENV["Per-Entity Environments<br/>self table + metatable"]
        HOOKS["Lifecycle Hooks<br/>init / update / on_reload"]
        API_IN["input API<br/>pressed / just_pressed"]
        API_ENT["entity API<br/>position/rotation/light/scale/visible"]
        API_CMD["entity commands<br/>spawn / destroy"]
        API_UI["ui API<br/>text / rect / flash / screen_size"]
        API_EVT["events API<br/>events.emit()"]
        API_PHY["physics API<br/>raycast / overlap"]
        API_AUD["audio API<br/>play_sfx / play_music"]
        GAME_T["game table<br/>shared state"]
    end

    subgraph INPUT["Input System"]
        BINDINGS["bindings.yaml<br/>action → key mapping"]
        IS["InputState<br/>held / just_pressed / delta"]
        SYNTH["Synthetic Injection<br/>inject_key_press()"]
        CURSOR["Cursor Capture<br/>FPS mouse lock"]
    end

    subgraph EVENTS["Event System"]
        EB["EventBus<br/>ring buffer log"]
        SCHEMA["events/schema.yaml<br/>validation"]
        EMIT["emit() / flush() / tick()"]
    end

    subgraph ASSETS["Asset System"]
        MESH_C["MeshCache<br/>procedural cube fallback"]
        MAT_C["MaterialCache<br/>YAML materials"]
        SPLAT_C["SplatCache<br/>PLY parser + GPU buffers"]
    end

    subgraph HOT["Hot-Reload (notify)"]
        WATCH["File Watcher"]
        W_SHADER["Shader Changed"]
        W_SCENE["Scene Changed"]
        W_MAT["Material Changed"]
        W_PIPE["Pipeline Changed"]
        W_SCRIPT["Script Changed"]
        W_SPLAT["Splat Changed"]
    end

    subgraph IPC["External Control"]
        SOCK["Unix Domain Socket<br/>/tmp/naive-runtime.sock"]
        CMD["Command Protocol<br/>JSON request/response"]
        MCP["MCP Server Binary<br/>naive_mcp"]
    end

    subgraph AUDIO["Audio (Kira)"]
        AUDIO_S["AudioSystem<br/>spatial audio"]
    end

    subgraph TWEEN["Animation"]
        TW["TweenSystem<br/>property animation"]
    end

    CLAP --> MAIN
    MAIN --> EL

    EL -->|"WindowEvent"| IS
    EL -->|"DeviceEvent"| IS
    EL -->|"RedrawRequested"| DT

    DT --> CHAR
    DT --> HOOKS
    DT --> EMIT
    DT --> TW

    YAML_P --> SCENE_F
    SCENE_F --> SPAWN
    SPAWN --> SW
    SPAWN --> MESH_C
    SPAWN --> MAT_C

    SW --> TRANSFORM
    SW --> MESH_R
    SW --> PL
    SW --> PLAYER
    SW --> CAM
    SW --> SCRIPT_C
    SW --> CC
    SW --> GS

    IS -->|"raw ptr"| API_IN
    SW -->|"raw mut ptr"| API_ENT
    ENT_CMD -->|"raw mut ptr"| API_CMD
    UI_R -->|"raw mut ptr"| API_UI
    EB -->|"raw mut ptr"| API_EVT
    PW -->|"raw ptr"| API_PHY
    AUDIO_S -->|"raw mut ptr"| API_AUD

    LUA --> ENV
    ENV --> HOOKS
    ENV --> GAME_T

    CHAR --> PW
    STEP --> SW

    PIPE_YAML --> COMPILED
    COMPILED --> SHADOW
    COMPILED --> GBUF
    COMPILED --> LIGHT
    COMPILED --> BLOOM_P
    COMPILED --> TONE
    COMPILED --> FXAA_P
    COMPILED --> SPLAT_P
    SLANG --> WGSL
    SLANG --> REFLECT

    FONT --> UI_R
    UI_R --> UI_TEXT
    UI_R --> UI_RECT
    UI_R --> UI_FLASH
    ENT_CMD -->|"deferred"| SW

    WATCH --> W_SHADER
    WATCH --> W_SCENE
    WATCH --> W_SCRIPT
    WATCH --> W_PIPE

    SOCK --> CMD
    CMD -->|"inject_input"| SYNTH
    CMD -->|"emit_event"| EB
    CMD -->|"query/modify"| SW
    MCP --> SOCK

    SYNTH --> IS

    classDef core fill:#e94560,stroke:#0f3460,color:#fff
    classDef ecs fill:#0f3460,stroke:#e94560,color:#fff
    classDef render fill:#533483,stroke:#e94560,color:#fff
    classDef script fill:#1a5276,stroke:#e94560,color:#fff
    classDef input fill:#1e8449,stroke:#fff,color:#fff
    classDef event fill:#b7950b,stroke:#fff,color:#000
    classDef ui fill:#7b2d8e,stroke:#e94560,color:#fff

    class EL,DT,PAUSE core
    class SW,TRANSFORM,MESH_R,PL,PLAYER,CAM,SCRIPT_C,CC,GS,TAGS,HIDDEN,MAT_OVR ecs
    class GPU,COMPILED,SHADOW,GBUF,LIGHT,BLOOM_P,TONE,FXAA_P,SPLAT_P,FWD render
    class LUA,ENV,HOOKS,API_IN,API_ENT,API_CMD,API_UI,API_EVT,API_PHY,API_AUD,GAME_T script
    class IS,BINDINGS,SYNTH,CURSOR input
    class EB,SCHEMA,EMIT event
    class FONT,UI_R,UI_TEXT,UI_RECT,UI_FLASH,ENT_CMD ui
    </pre>
  </div>

  <h2>Frame Update Sequence</h2>
  <div class="diagram">
    <pre class="mermaid">
sequenceDiagram
    participant W as winit
    participant E as Engine
    participant I as InputState
    participant P as PhysicsWorld
    participant S as ScriptRuntime
    participant Q as EntityCmdQueue
    participant EB as EventBus
    participant R as Renderer
    participant U as UiRenderer

    W->>E: KeyboardInput / MouseInput
    E->>I: handle_window_event()

    W->>E: RedrawRequested
    E->>E: calculate delta_time

    Note over E: Escape → release cursor
    Note over E: Any key → capture cursor

    E->>I: axis_2d() / pressed()
    E->>P: move_character(desired_velocity)
    P->>P: step(dt)
    P-->>E: sync_to_ecs()

    loop For each Script entity
        E->>S: call_update(entity, dt)
        S->>I: input.just_pressed()
        S->>EB: events.emit()
        S->>E: entity.set_position()
        S->>Q: entity.spawn() / destroy()
        S->>U: ui.text() / ui.rect()
    end

    E->>Q: process_entity_commands()
    Q-->>E: spawn / destroy / scale / visible

    E->>EB: tick(dt) + flush()
    E->>E: update_transforms()

    E->>R: execute_pipeline_to_view()
    R->>R: Shadow Pass
    R->>R: G-Buffer Pass
    R->>R: Splat Pass
    R->>R: Lighting Pass (Cook-Torrance GGX)
    R->>R: Bloom Pass
    R->>R: Tonemap Pass
    R->>R: FXAA Pass

    E->>U: ui.render() [LoadOp::Load]
    U->>U: colored rects pipeline
    U->>U: textured text pipeline

    E->>E: present swapchain
    E->>I: begin_frame() [clear transient]
    E->>W: request_redraw()
    </pre>
  </div>

  <h2>Data Flow: Scene Loading</h2>
  <div class="diagram">
    <pre class="mermaid">
flowchart LR
    A["relic.yaml"] -->|"serde_yaml"| B["SceneFile"]
    B -->|"spawn_all_entities()"| C["hecs World"]
    C --> D["Transform"]
    C --> E["MeshRenderer"]
    C --> F["PointLight"]
    C --> G["Camera + Player"]
    C --> H["CharacterController"]
    C --> I["Script"]

    E -->|"mesh path"| J["MeshCache<br/>procedural cube"]
    E -->|"material path"| K["MaterialCache<br/>YAML → uniforms"]

    H -->|"Rapier body"| L["PhysicsWorld"]

    I -->|"load .lua"| M["ScriptRuntime"]
    M -->|"raw ptrs"| N["InputState"]
    M -->|"raw ptrs"| O["SceneWorld"]
    M -->|"raw ptrs"| P["EventBus"]
    M -->|"raw ptrs"| L

    style A fill:#e94560
    style C fill:#0f3460,color:#fff
    style L fill:#533483,color:#fff
    style M fill:#1a5276,color:#fff
    </pre>
  </div>

  <h2>Full Rendering Pipeline</h2>
  <div class="diagram">
    <pre class="mermaid">
flowchart LR
    subgraph Shadow["Shadow Pass"]
        SH1["Directional Light View"]
        SH2["Depth-only Render<br/>shadow_depth texture"]
    end

    subgraph GBuf["G-Buffer Pass"]
        G1["Vertex Shader<br/>MVP transform"]
        G2["Fragment Shader<br/>output albedo, normal, depth"]
    end

    subgraph Splat["Splat Pass (optional)"]
        S1["Billboard Quads<br/>sorted back-to-front"]
        S2["2D Gaussian<br/>alpha blending"]
    end

    subgraph Light["Lighting Pass"]
        L1["Fullscreen Quad"]
        L2["Reconstruct world pos<br/>inv_view_projection × depth"]
        L3["Cook-Torrance GGX<br/>D·F·G / (4·NdotL·NdotV)"]
        L4["Shadow Sampling<br/>PCF soft shadows"]
        L5["Depth Composite<br/>mesh vs splat"]
    end

    subgraph Bloom["Bloom Pass"]
        BL1["HDR Threshold<br/>extract bright pixels"]
        BL2["Gaussian Blur<br/>separable kernel"]
        BL3["Additive Blend<br/>bloom + scene"]
    end

    subgraph Tone["Tonemap Pass"]
        T1["Reinhard Tonemap"]
        T2["Gamma Correction"]
    end

    subgraph FXAA["FXAA Pass"]
        FX1["Edge Detection<br/>luma contrast"]
        FX2["Subpixel Blend<br/>anti-aliased output"]
    end

    subgraph UIPass["UI Overlay Pass"]
        UI1["Colored Rects Pipeline<br/>solid quads, alpha blend"]
        UI2["Textured Text Pipeline<br/>6×8 bitmap font atlas"]
        UI3["Screen Flash<br/>fullscreen fade effect"]
    end

    Shadow -->|"shadow_depth"| Light
    GBuf -->|"albedo_rt<br/>normal_rt<br/>depth"| Light
    Splat -->|"splat_color<br/>splat_depth"| Light
    Light -->|"hdr_rt"| Bloom
    Bloom -->|"bloom_rt"| Tone
    Tone -->|"ldr_rt"| FXAA
    FXAA -->|"swapchain"| UIPass
    UIPass -->|"LoadOp::Load"| SCREEN["Display"]

    style Shadow fill:#2c3e50,color:#fff
    style GBuf fill:#0f3460,color:#fff
    style Splat fill:#533483,color:#fff
    style Light fill:#1a5276,color:#fff
    style Bloom fill:#8e44ad,color:#fff
    style Tone fill:#e94560,color:#fff
    style FXAA fill:#27ae60,color:#fff
    style UIPass fill:#7b2d8e,color:#fff
    </pre>
  </div>

  <h2>Relic Game Entity Map</h2>
  <div class="diagram">
    <pre class="mermaid">
graph TD
    subgraph Room["Dungeon Room 16×5×16"]
        FLOOR["floor<br/>stone cube"]
        CEIL["ceiling<br/>stone cube"]
        WN["wall_north"]
        WS["wall_south"]
        WE["wall_east"]
        WW["wall_west"]
    end

    subgraph Gameplay["Interactive Entities"]
        PLAYER["player<br/>Camera + CharacterController<br/>player_fps.lua"]
        GATE["gate<br/>door_swing.lua<br/>E to open"]
        GUARDIAN["guardian<br/>guardian.lua<br/>patrol → chase → attack"]
        RELIC["relic<br/>relic_pickup.lua<br/>E to collect → win"]
    end

    subgraph Decor["Decoration"]
        T1["torch_01<br/>torch_flicker.lua"]
        T2["torch_02"]
        T3["torch_03"]
        T4["torch_04"]
        P1["pillar_01"]
        P2["pillar_02"]
        P3["pillar_03"]
        P4["pillar_04"]
        PED["pedestal"]
    end

    PLAYER -->|"interact"| GATE
    PLAYER -->|"attack"| GUARDIAN
    PLAYER -->|"interact"| RELIC
    GUARDIAN -->|"guards"| RELIC
    RELIC -->|"sits on"| PED

    style PLAYER fill:#e94560,color:#fff
    style GUARDIAN fill:#1e8449,color:#fff
    style RELIC fill:#b7950b,color:#000
    style GATE fill:#784212,color:#fff
    </pre>
  </div>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#0f3460',
        primaryTextColor: '#e0e0e0',
        primaryBorderColor: '#e94560',
        lineColor: '#e94560',
        secondaryColor: '#533483',
        tertiaryColor: '#1a5276'
      }
    });
  </script>
</body>
</html>
