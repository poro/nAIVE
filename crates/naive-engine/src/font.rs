/// Bitmap font atlas — programmatically generated 6x8 pixel font.
/// Covers ASCII 32–126 (95 printable characters) in a 16×6 grid.

/// GPU-resident bitmap font atlas.
pub struct BitmapFont {
    pub _texture: wgpu::Texture,
    pub texture_view: wgpu::TextureView,
    pub _sampler: wgpu::Sampler,
    pub bind_group_layout: wgpu::BindGroupLayout,
    pub bind_group: wgpu::BindGroup,
    pub glyph_w: f32,
    pub glyph_h: f32,
    pub cols: u32,
    pub atlas_w: f32,
    pub atlas_h: f32,
}

/// Create the bitmap font, generating the atlas and uploading to GPU.
pub fn create_bitmap_font(device: &wgpu::Device, queue: &wgpu::Queue) -> BitmapFont {
    let (atlas_w, atlas_h, rgba_data) = generate_font_atlas();

    let texture = device.create_texture(&wgpu::TextureDescriptor {
        label: Some("Font Atlas"),
        size: wgpu::Extent3d {
            width: atlas_w,
            height: atlas_h,
            depth_or_array_layers: 1,
        },
        mip_level_count: 1,
        sample_count: 1,
        dimension: wgpu::TextureDimension::D2,
        format: wgpu::TextureFormat::Rgba8UnormSrgb,
        usage: wgpu::TextureUsages::TEXTURE_BINDING | wgpu::TextureUsages::COPY_DST,
        view_formats: &[],
    });

    queue.write_texture(
        wgpu::TexelCopyTextureInfo {
            texture: &texture,
            mip_level: 0,
            origin: wgpu::Origin3d::ZERO,
            aspect: wgpu::TextureAspect::All,
        },
        &rgba_data,
        wgpu::TexelCopyBufferLayout {
            offset: 0,
            bytes_per_row: Some(atlas_w * 4),
            rows_per_image: Some(atlas_h),
        },
        wgpu::Extent3d {
            width: atlas_w,
            height: atlas_h,
            depth_or_array_layers: 1,
        },
    );

    let texture_view = texture.create_view(&wgpu::TextureViewDescriptor::default());

    let sampler = device.create_sampler(&wgpu::SamplerDescriptor {
        label: Some("Font Sampler"),
        mag_filter: wgpu::FilterMode::Nearest,
        min_filter: wgpu::FilterMode::Nearest,
        ..Default::default()
    });

    let bind_group_layout = device.create_bind_group_layout(&wgpu::BindGroupLayoutDescriptor {
        label: Some("Font Bind Group Layout"),
        entries: &[
            wgpu::BindGroupLayoutEntry {
                binding: 0,
                visibility: wgpu::ShaderStages::FRAGMENT,
                ty: wgpu::BindingType::Texture {
                    sample_type: wgpu::TextureSampleType::Float { filterable: true },
                    view_dimension: wgpu::TextureViewDimension::D2,
                    multisampled: false,
                },
                count: None,
            },
            wgpu::BindGroupLayoutEntry {
                binding: 1,
                visibility: wgpu::ShaderStages::FRAGMENT,
                ty: wgpu::BindingType::Sampler(wgpu::SamplerBindingType::Filtering),
                count: None,
            },
        ],
    });

    let bind_group = device.create_bind_group(&wgpu::BindGroupDescriptor {
        label: Some("Font Bind Group"),
        layout: &bind_group_layout,
        entries: &[
            wgpu::BindGroupEntry {
                binding: 0,
                resource: wgpu::BindingResource::TextureView(&texture_view),
            },
            wgpu::BindGroupEntry {
                binding: 1,
                resource: wgpu::BindingResource::Sampler(&sampler),
            },
        ],
    });

    tracing::info!("Bitmap font atlas created ({}x{}, {} glyphs)", atlas_w, atlas_h, GLYPH_COUNT);

    BitmapFont {
        _texture: texture,
        texture_view,
        _sampler: sampler,
        bind_group_layout,
        bind_group,
        glyph_w: GLYPH_W as f32,
        glyph_h: GLYPH_H as f32,
        cols: ATLAS_COLS,
        atlas_w: atlas_w as f32,
        atlas_h: atlas_h as f32,
    }
}

/// Get UV coordinates for a character: [u0, v0, u1, v1].
pub fn glyph_uvs(font: &BitmapFont, ch: char) -> [f32; 4] {
    let code = ch as u32;
    if code < 32 || code > 126 {
        return glyph_uvs(font, '?');
    }
    let idx = code - 32;
    let col = idx % font.cols;
    let row = idx / font.cols;
    let u0 = (col as f32 * font.glyph_w) / font.atlas_w;
    let v0 = (row as f32 * font.glyph_h) / font.atlas_h;
    let u1 = u0 + font.glyph_w / font.atlas_w;
    let v1 = v0 + font.glyph_h / font.atlas_h;
    [u0, v0, u1, v1]
}

// --- Atlas constants ---

const GLYPH_W: u32 = 6;
const GLYPH_H: u32 = 8;
const ATLAS_COLS: u32 = 16;
const ATLAS_ROWS: u32 = 6;
const GLYPH_COUNT: u32 = 95; // ASCII 32–126

/// Generate the font atlas as RGBA pixel data.
fn generate_font_atlas() -> (u32, u32, Vec<u8>) {
    let w = ATLAS_COLS * GLYPH_W;
    let h = ATLAS_ROWS * GLYPH_H;
    let mut pixels = vec![0u8; (w * h * 4) as usize];

    for i in 0..GLYPH_COUNT {
        let bitmap = &FONT_DATA[i as usize];
        let col = i % ATLAS_COLS;
        let row = i / ATLAS_COLS;
        let x0 = col * GLYPH_W;
        let y0 = row * GLYPH_H;

        for dy in 0..GLYPH_H {
            let bits = bitmap[dy as usize];
            for dx in 0..GLYPH_W {
                if bits & (1 << (7 - dx)) != 0 {
                    let px = x0 + dx;
                    let py = y0 + dy;
                    let off = ((py * w + px) * 4) as usize;
                    pixels[off] = 255;     // R
                    pixels[off + 1] = 255; // G
                    pixels[off + 2] = 255; // B
                    pixels[off + 3] = 255; // A
                }
                // else: stays (0,0,0,0) = transparent
            }
        }
    }

    (w, h, pixels)
}

// 6x8 bitmap font data for ASCII 32-126 (95 glyphs).
// Each glyph is 8 bytes (8 rows), top 6 bits used per row.
#[rustfmt::skip]
const FONT_DATA: [[u8; 8]; 95] = [
    // 32: ' ' (space)
    [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    // 33: '!'
    [0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00],
    // 34: '"'
    [0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00],
    // 35: '#'
    [0x50,0x50,0xF8,0x50,0xF8,0x50,0x50,0x00],
    // 36: '$'
    [0x20,0x78,0xA0,0x70,0x28,0xF0,0x20,0x00],
    // 37: '%'
    [0xC0,0xC8,0x10,0x20,0x40,0x98,0x18,0x00],
    // 38: '&'
    [0x60,0x90,0xA0,0x40,0xA8,0x90,0x68,0x00],
    // 39: '\''
    [0x60,0x20,0x40,0x00,0x00,0x00,0x00,0x00],
    // 40: '('
    [0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00],
    // 41: ')'
    [0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00],
    // 42: '*'
    [0x00,0x20,0xA8,0x70,0xA8,0x20,0x00,0x00],
    // 43: '+'
    [0x00,0x20,0x20,0xF8,0x20,0x20,0x00,0x00],
    // 44: ','
    [0x00,0x00,0x00,0x00,0x60,0x20,0x40,0x00],
    // 45: '-'
    [0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00],
    // 46: '.'
    [0x00,0x00,0x00,0x00,0x00,0x60,0x60,0x00],
    // 47: '/'
    [0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00],
    // 48: '0'
    [0x70,0x88,0x98,0xA8,0xC8,0x88,0x70,0x00],
    // 49: '1'
    [0x20,0x60,0x20,0x20,0x20,0x20,0x70,0x00],
    // 50: '2'
    [0x70,0x88,0x08,0x10,0x20,0x40,0xF8,0x00],
    // 51: '3'
    [0xF8,0x10,0x20,0x10,0x08,0x88,0x70,0x00],
    // 52: '4'
    [0x10,0x30,0x50,0x90,0xF8,0x10,0x10,0x00],
    // 53: '5'
    [0xF8,0x80,0xF0,0x08,0x08,0x88,0x70,0x00],
    // 54: '6'
    [0x30,0x40,0x80,0xF0,0x88,0x88,0x70,0x00],
    // 55: '7'
    [0xF8,0x08,0x10,0x20,0x40,0x40,0x40,0x00],
    // 56: '8'
    [0x70,0x88,0x88,0x70,0x88,0x88,0x70,0x00],
    // 57: '9'
    [0x70,0x88,0x88,0x78,0x08,0x10,0x60,0x00],
    // 58: ':'
    [0x00,0x60,0x60,0x00,0x60,0x60,0x00,0x00],
    // 59: ';'
    [0x00,0x60,0x60,0x00,0x60,0x20,0x40,0x00],
    // 60: '<'
    [0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x00],
    // 61: '='
    [0x00,0x00,0xF8,0x00,0xF8,0x00,0x00,0x00],
    // 62: '>'
    [0x80,0x40,0x20,0x10,0x20,0x40,0x80,0x00],
    // 63: '?'
    [0x70,0x88,0x08,0x10,0x20,0x00,0x20,0x00],
    // 64: '@'
    [0x70,0x88,0xB8,0xA8,0xB8,0x80,0x70,0x00],
    // 65: 'A'
    [0x70,0x88,0x88,0xF8,0x88,0x88,0x88,0x00],
    // 66: 'B'
    [0xF0,0x88,0x88,0xF0,0x88,0x88,0xF0,0x00],
    // 67: 'C'
    [0x70,0x88,0x80,0x80,0x80,0x88,0x70,0x00],
    // 68: 'D'
    [0xE0,0x90,0x88,0x88,0x88,0x90,0xE0,0x00],
    // 69: 'E'
    [0xF8,0x80,0x80,0xF0,0x80,0x80,0xF8,0x00],
    // 70: 'F'
    [0xF8,0x80,0x80,0xF0,0x80,0x80,0x80,0x00],
    // 71: 'G'
    [0x70,0x88,0x80,0xB8,0x88,0x88,0x78,0x00],
    // 72: 'H'
    [0x88,0x88,0x88,0xF8,0x88,0x88,0x88,0x00],
    // 73: 'I'
    [0x70,0x20,0x20,0x20,0x20,0x20,0x70,0x00],
    // 74: 'J'
    [0x38,0x10,0x10,0x10,0x10,0x90,0x60,0x00],
    // 75: 'K'
    [0x88,0x90,0xA0,0xC0,0xA0,0x90,0x88,0x00],
    // 76: 'L'
    [0x80,0x80,0x80,0x80,0x80,0x80,0xF8,0x00],
    // 77: 'M'
    [0x88,0xD8,0xA8,0xA8,0x88,0x88,0x88,0x00],
    // 78: 'N'
    [0x88,0xC8,0xA8,0x98,0x88,0x88,0x88,0x00],
    // 79: 'O'
    [0x70,0x88,0x88,0x88,0x88,0x88,0x70,0x00],
    // 80: 'P'
    [0xF0,0x88,0x88,0xF0,0x80,0x80,0x80,0x00],
    // 81: 'Q'
    [0x70,0x88,0x88,0x88,0xA8,0x90,0x68,0x00],
    // 82: 'R'
    [0xF0,0x88,0x88,0xF0,0xA0,0x90,0x88,0x00],
    // 83: 'S'
    [0x78,0x80,0x80,0x70,0x08,0x08,0xF0,0x00],
    // 84: 'T'
    [0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x00],
    // 85: 'U'
    [0x88,0x88,0x88,0x88,0x88,0x88,0x70,0x00],
    // 86: 'V'
    [0x88,0x88,0x88,0x88,0x50,0x50,0x20,0x00],
    // 87: 'W'
    [0x88,0x88,0x88,0xA8,0xA8,0xD8,0x88,0x00],
    // 88: 'X'
    [0x88,0x88,0x50,0x20,0x50,0x88,0x88,0x00],
    // 89: 'Y'
    [0x88,0x88,0x50,0x20,0x20,0x20,0x20,0x00],
    // 90: 'Z'
    [0xF8,0x08,0x10,0x20,0x40,0x80,0xF8,0x00],
    // 91: '['
    [0x70,0x40,0x40,0x40,0x40,0x40,0x70,0x00],
    // 92: '\\'
    [0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00],
    // 93: ']'
    [0x70,0x10,0x10,0x10,0x10,0x10,0x70,0x00],
    // 94: '^'
    [0x20,0x50,0x88,0x00,0x00,0x00,0x00,0x00],
    // 95: '_'
    [0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00],
    // 96: '`'
    [0x40,0x20,0x10,0x00,0x00,0x00,0x00,0x00],
    // 97: 'a'
    [0x00,0x00,0x70,0x08,0x78,0x88,0x78,0x00],
    // 98: 'b'
    [0x80,0x80,0xB0,0xC8,0x88,0xC8,0xB0,0x00],
    // 99: 'c'
    [0x00,0x00,0x70,0x80,0x80,0x88,0x70,0x00],
    // 100: 'd'
    [0x08,0x08,0x68,0x98,0x88,0x98,0x68,0x00],
    // 101: 'e'
    [0x00,0x00,0x70,0x88,0xF8,0x80,0x70,0x00],
    // 102: 'f'
    [0x30,0x48,0x40,0xE0,0x40,0x40,0x40,0x00],
    // 103: 'g'
    [0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x70],
    // 104: 'h'
    [0x80,0x80,0xB0,0xC8,0x88,0x88,0x88,0x00],
    // 105: 'i'
    [0x20,0x00,0x60,0x20,0x20,0x20,0x70,0x00],
    // 106: 'j'
    [0x10,0x00,0x30,0x10,0x10,0x10,0x90,0x60],
    // 107: 'k'
    [0x80,0x80,0x90,0xA0,0xC0,0xA0,0x90,0x00],
    // 108: 'l'
    [0x60,0x20,0x20,0x20,0x20,0x20,0x70,0x00],
    // 109: 'm'
    [0x00,0x00,0xD0,0xA8,0xA8,0x88,0x88,0x00],
    // 110: 'n'
    [0x00,0x00,0xB0,0xC8,0x88,0x88,0x88,0x00],
    // 111: 'o'
    [0x00,0x00,0x70,0x88,0x88,0x88,0x70,0x00],
    // 112: 'p'
    [0x00,0x00,0xB0,0xC8,0xC8,0xB0,0x80,0x80],
    // 113: 'q'
    [0x00,0x00,0x68,0x98,0x98,0x68,0x08,0x08],
    // 114: 'r'
    [0x00,0x00,0xB0,0xC8,0x80,0x80,0x80,0x00],
    // 115: 's'
    [0x00,0x00,0x78,0x80,0x70,0x08,0xF0,0x00],
    // 116: 't'
    [0x40,0x40,0xE0,0x40,0x40,0x48,0x30,0x00],
    // 117: 'u'
    [0x00,0x00,0x88,0x88,0x88,0x98,0x68,0x00],
    // 118: 'v'
    [0x00,0x00,0x88,0x88,0x88,0x50,0x20,0x00],
    // 119: 'w'
    [0x00,0x00,0x88,0x88,0xA8,0xA8,0x50,0x00],
    // 120: 'x'
    [0x00,0x00,0x88,0x50,0x20,0x50,0x88,0x00],
    // 121: 'y'
    [0x00,0x00,0x88,0x88,0x98,0x68,0x08,0x70],
    // 122: 'z'
    [0x00,0x00,0xF8,0x10,0x20,0x40,0xF8,0x00],
    // 123: '{'
    [0x18,0x20,0x20,0x40,0x20,0x20,0x18,0x00],
    // 124: '|'
    [0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00],
    // 125: '}'
    [0xC0,0x20,0x20,0x10,0x20,0x20,0xC0,0x00],
    // 126: '~'
    [0x40,0xA8,0x10,0x00,0x00,0x00,0x00,0x00],
];
